# Cron task configuration required for this project.
# These will be executed on web EC2 units instead of a worker unit such that they can be scaled as needed.
# All cron tasks should be executed as webapp for security.
container_commands:
  50_webapp_home:
    command: sudo mkdir -p /home/webapp
  51_webapp_permission:
    command: sudo chown -R webapp:webapp /home/webapp
  52_remove_previous_cron_webapp:
    command: sudo crontab -u webapp -r || exit 0
  53_remove_previous_cron_root:
    command: sudo crontab -u root -r || exit 0
  54_remove_previous_cron_backups:
    command: sudo rm -f /etc/cron.d/*.bak

files:
  "/etc/cron.d/project":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Outgoing mail queue has highest priority.
      * * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:emails:send --no-interaction --no-ansi --time-limit 60

      # Other tasks occur as frequently as possible, without overlapping eachother more than necessary.
      0,7,14,21,28,35,42,49,56 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:campaigns:rebuild --no-interaction --no-ansi
      1,8,15,22,29,36,43,50,57 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:campaigns:trigger --no-interaction --no-ansi
      2,9,16,23,30,37,44,51,58 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:messages:send --no-interaction --no-ansi
      3,10,17,24,31,38,45,52,59 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:segments:update --no-interaction --no-ansi
      4,11,18,25,32,39,46,53 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:email:fetch --no-interaction --no-ansi
      5,12,19,26,33,40,47,54 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:webhooks:process --no-interaction --no-ansi
      6,13,20,27,34,41,48,55 * * * * root bash /var/app/current/scripts/aws-eb-cron.sh /usr/bin/php /var/app/current/mautic/app/console mautic:broadcasts:send --no-interaction --no-ansi

      # Update maxmind databse at 9am on first Tuesday of each month on all instances.
      0 9 * * 2 webapp [ `date +\%d` -le 7 ] && /usr/bin/php /var/app/current/mautic/app/console mautic:iplookup:download --no-interaction --no-ansi



