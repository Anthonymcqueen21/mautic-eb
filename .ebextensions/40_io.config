# Disk permissions and mounts required for this project.
packages:
  yum:
    nfs-utils: []

container_commands:
  # First create any missing folders and establish the baseline permissions.
  40_io_permissions:
    command: |
      mkdir -p \
        mautic/app/cache \
        mautic/app/logs \
        mautic/app/spool \
        mautic/media/files \
        mautic/translations
      chown -R webapp:webapp .
      touch \
        mautic/app/bootstrap.php.cache \
        mautic/.php_cs
      chgrp -R webapp \
        mautic/app/bootstrap.php.cache \
        mautic/.php_cs \
        mautic/media \
        mautic/app/cache \
        mautic/app/logs \
        mautic/app/spool
      chmod -R ug+wx \
        mautic/app/bootstrap.php.cache \
        mautic/.php_cs \
        mautic/media \
        mautic/app/cache \
        mautic/app/logs \
        mautic/app/spool
  # Mount our EFS drive for shared storage across nodes.
  41_io_efs_mount:
    command: sudo bash scripts/aws-efs-mount.sh
  # Ensure the EFS mount has our desired writable folders.
  42_io_efs_create_folders:
    leader_only: true
    command: mkdir -p \
      /efs/mautic \
      /efs/mautic/app \
      /efs/mautic/app/logs \
      /efs/mautic/app/spool \
      /efs/mautic/media \
      /efs/mautic/media/files \
      /efs/mautic/media/dashboards \
      /efs/mautic/media/images \
      /efs/mautic/multi \
      /efs/mautic/translations
  # Sync updates from our deployment overwriting any alterations to the defaults within EFS.
  43_io_efs_rsync_updates:
    leader_only: true
    command: |
      rsync -avh mautic/media/files/ /efs/mautic/media/files/
      rsync -avh mautic/media/dashboards/ /efs/mautic/media/dashboards/
      rsync -avh mautic/media/images/ /efs/mautic/media/images/
      rsync -avh mautic/translations/ /efs/mautic/translations/
  # Replace our local writable folders with symlinks to the EFS mounted equivalents.
  # Each instance has it's own ./mautic/app/cache directory for deployment stability, but everything else can be linked.
  44_io_efs_links:
    command: |
      rm -rf mautic/app/logs
      ln -sf /efs/mautic/app/logs mautic/app
      rm -rf mautic/app/spool
      ln -sf /efs/mautic/app/spool mautic/app
      rm -rf mautic/media/files
      ln -sf /efs/mautic/media/files mautic/media
      rm -rf mautic/media/dashboards
      ln -sf /efs/mautic/media/dashboards mautic/media
      rm -rf mautic/media/images
      ln -sf /efs/mautic/media/images mautic/media
      rm -rf mautic/multi
      ln -sf /efs/mautic/multi mautic
      rm -rf mautic/translations
      ln -sf /efs/mautic/translations mautic
  # Override all EFS permissions as a precaution. At large scale this step may need to be removed.
  45_io_efs_permissions:
    leader_only: true
    command: |
      chown -R webapp:webapp /efs/mautic
      chgrp -R webapp /efs/mautic
      chmod -R ug+wx /efs/mautic
